# 第一章 操作系统概述
## 一、操作系统的概念和功能
![alt text](/操作系统/picture/{3FD895C6-4966-4921-8B02-EE938D9C70FC}.png)
### 1.概念
定义：指*控制和管理整个计算机系统的硬件和软件资源*，并合理地组织调度计算机的工作的资源的分配；以*提供给用户和其他软件方便的接口和环境*；它是计算机系统中最基本的软件系统。

### 2.功能和目标
1. 操作系统是系统资源的管理者
![alt text](/操作系统/picture/{7D800743-E8E3-4362-8E2D-B907EF0FB15B}.png)
2. 向上提供方便易用的服务（封装思想，硬件只能听懂二进制语言，操作系统把硬件功能封装成简单易用的服务，使用户可以方便的使用计算机，用户无需知道运行的原理便可使用）
>   - 提供gui图形化用户接口方便用户使用
>   - 早期只能通过命令接口操作计算机（a.联机命令接口 = 交互式命令接口 b.脱机命令接口 = 批处理命令接口（将一系列命令记录在记事本中*.bat文件，有计算机一次执行））
>   - 程序接口：可以在程序中进行系统调用（广义指令）来使用程序接口。普通用户不可直接使用程序接口，只能通过程序代码间接使用。
![alt text](/操作系统/picture/{325B408B-1C76-4325-AA27-AC1D245998D0}.png)
3. 操作系统是最接近硬件的层次
>   - 实现对硬件机器的拓展：将CPU，内存，磁盘，显示器，键盘等硬件合理的组织起来，让各种硬件能够相互协调配合，实现更多更复杂的功能。
### 3.总结
![alt text](/操作系统/picture/{5FC7C9B0-1B4F-4148-8731-79B9ECF1F8BE}.png)

## 二、操作系统的特征
![alt text](/操作系统/picture/{0B6888FB-416A-40B0-84AA-ECAA417FAC29}.png)

### 1.并发
指两个或多个事件在同一时间间隔内发生。这些事件宏观上是同时发生的，但微观上是交替发生的。注意不要和并行概念混合：并行指两个或多个事件在同一时刻同时发生。
![alt text](/操作系统/picture/{B266435D-A468-4655-A296-7BC505489278}.png)
操作系统的并发性：指计算机系统中“同时”运行着多个程序，这些程序宏观上看是同时运行着的，而微观上看是交替运行的。
>操作系统就是伴随着“多道程序技术”而出现的。因此，*操作系统和程序并发是一起诞生的*。
**注意**：
>单核CPU同一时刻只能执行一个程序，各个程序只能并发地执行
>多核CPU同一时刻可以同时执行多个程序，多个程序可以并行地执行
### 2.共享
指资源共享，系统中的资源可供内存中多个并发执行的进程共同使用。

两种共享方式：
1. 互斥共享方式：系统中的某些资源，虽然可以提供给多个进程使用，但一个时间段内只允许一个进程访问该资源。
2. 同时共享方式：系统中的某些资源，允许一个时间段内由多个进程“同时”对他们进行访问。
>所谓的"同时"往往是宏观上的，而在微观上，这些进程可能是交替地对该资源进行访问地（即**分时共享**）。但是也可能是真地同时，比如扬声器同时播放qq音乐和b站视频，即微观上计算机也同时访问扬声器这个资源。
**并发和共享地关系**
![alt text](/操作系统/picture/{CAC8704B-BA40-4C24-B9E0-F767A3ACC360}.png)
### 3.虚拟
指把一个物理上的实体变为若干个逻辑上地对应物。物理实体（前者）是实际存在的，而逻辑上对应物（后者）是用户感受到的。
![alt text](/操作系统/picture/{C3D51A3B-176E-4F7D-8B0A-369D48091AFE}.png)
![alt text](/操作系统/picture/{A60D070F-5F6C-405E-93F9-BF6EA8306F5D}.png)
虚拟技术：
1. 空分复用技术
2. 时分复用技术
> 显然，如果失去了并发性，则一个时间段内系统中只需允许一道程序，那么就失去了实现虚拟性地意义了，因此，没有并发性就谈不上虚拟性。
### 4.异步
指在多道程序环境下，允许多个程序并发执行，但由于资源有限，进程地执行不是一贯到底地，而是走走停停，以不可预知地速度向前推进，这就是进程地异步性。
![alt text](/操作系统/picture/{85DE4E66-7722-432D-A04A-6D39A625DEC4}.png)
### 5.总结
![alt text](/操作系统/picture/{4BD9D663-F635-4E72-9D59-097FF4B3F517}.png)

## 三、操作系统的发展和分类
1. 手工操作阶段
    - 在纸带机写代码，将纸带装进计算机，计算机读取纸带机执行操作。
    ![alt text](/操作系统/picture/{54D0B314-356A-42B7-9C40-BF2AA59E55D3}.png)
1. 单道批处理系统
    - 引入脱机输入、输出技术（用外围机+磁带完成），并由监督程序负责控制作业的输入、输出。并由监督程序（操作系统的雏形）负责控制作业的输入和输出。
    ![alt text](/操作系统/picture/{06FD83F4-2CDC-4BFB-A3A1-123AAD77FB73}.png)
1. 多道批处理系统
    - 操作系统正式诞生
    ![alt text](/操作系统/picture/{E3664D9F-BE0F-4FFE-A852-38363C80E5B9}.png)
4. 分时操作系统
    - 计算机以时间片为单位轮流为各个用户/作业服务，各个用户可通过终端与计算机进行交互。
    ![alt text](/操作系统/picture/{2760ED74-D46B-40B7-AA65-42D5CA2CF2B9}.png)
5. 实时操作系统
    ![alt text](/操作系统/picture/{E6462F24-9270-44B8-8CC0-C873A7DE36C0}.png)
6. 其他操作系统
    ![alt text](/操作系统/picture/{B4FAC203-EC49-4E13-A2A8-D6290E1B8409}.png)
    
### 总结
![alt text](/操作系统/picture/{53D7FEB1-22B9-4B80-98C9-72D74FC69E61}.png)

## 四、操作系统的运行机制
![alt text](/操作系统/picture/{82FD7C1F-444E-483B-B688-94E5E0BAD518}.png)
### 1.指令
定义：就是处理器CPU能识别、执行的最基本命令。
### 2.内核程序vs.应用程序
普通程序员写的程序是应用程序，比如qq，微信等  
微软、苹果等实现的操作系统，是内核程序，由很多内核程序组成了“操作系统内核”，称为“内核（kernel）”。内核时操作系统最重要和核心的部分，也是最接近硬件的部分。  
甚至可以说，一个操作系统只要有内核就足够了（eg：Docker仅需linux内核）。但操作系统的功能未必都在内核中，如图形化用户界面GUI。
### 3.特权指令vs.非特权指令
操作系统内核作为管理者，有时会让CPU执行一些特权指令，如内存清零指令。这些指令影响重大，只允许管理者即操作系统内核来使用。应用程序只能使用非特权指令，如加法指令、减法指令等。  
在CPU设计和生产大的时候就划分了特权指令和非特权指令，因此CPU执行一条命令前就能判断出其类型。
### 4.内核态vs.用户态
![alt text](/操作系统/picture/{6270BCF5-6FC0-44A1-A1EB-CA1C251D2470}.png)
**内核态、用户态的切换**
![alt text](/操作系统/picture/{405DB7EC-60B9-4EEF-A165-0A75C9E56FB6}.png)
### 5.总结
![alt text](/操作系统/picture/{608B88BF-E362-40BD-872F-6619EB228866}.png)

## 五、中断和异常
![alt text](/操作系统/picture/{D0D07B0A-0E95-4969-BC6C-36A506F77D08}.png)
### 1.中断的作用
![alt text](/操作系统/picture/{5956467C-851B-49EC-B38F-271BB2F8AD0D}.png)
### 2.中断的类型
1. 内中断
   > **与当前执行的指令有关，中断信号来源于CPU内部**
   - 例如：
   - 1. 试图在用户态下执行特权指令：当应用程序中有一条特权指令，则会发出中断信号，因此CPU处理中断信号，转为内核态
   - 2. 若当前执行的指令是非法的，则会引发一个中断信号：执行除法发现除数为0
   - 3. 有时应用程序想请求操作系统内核的服务，此时会执行一条特殊的指令--陷入指令（非特权指令），该指令会引发一个内部中断信号。陷入指令的执行意味着应用程序主动地将CPU控制权还给操作系统内核，系统调用就是通过陷入指令完成地。
    >系统调用是指运行在用户空间的程序向操作系统内核请求需要更高权限运行的服务。它提供了用户程序与操作系统之间的接口，使用户程序能够访问和使用操作系统的核心功能。
2. 外中断
   > **与当前执行的指令无关，中断信号来源于CPU外部**
    - 例如：
    - 1. 时钟中断：由时钟部件发来地中断信号
    > 时钟部件：每隔一个时间（如50ms）会给CPU发送一个时钟中断信号
    - 2. I/O中断：由输入/输出设备发来地中断信号
    > 当输入输出任务完成时，会向CPU发送中断信号  

    *CPU在每一条指令执行结束时，都会例行检查是否有外中断信号*
### 3.中断地分类
![alt text](/操作系统/picture/{DFF6C5EC-48E1-4DE5-9E79-89C117561AC5}.png)
### 4.中断机制的基本原理
![alt text](/操作系统/picture/{FF47353D-C9D1-453A-B98A-C39305E23B33}.png)
### 5.总结
![alt text](/操作系统/picture/{72428D93-E16D-4C2F-BA65-A975E0FF5FAA}.png)

## 六、系统调用
定义：系统调用是操作系统提供给应用程序使用的接口，可以理解为一种可供应用程序调用的特殊函数，应用程序可以通过系统调用来请求获得操作系统内核的服务。
### 1.系统调用和库函数的区别
![alt text](/操作系统/picture/{BCDBB7BC-4056-4F93-BDF8-A16FC24162BB}.png)
### 2.为什么系统调用是必须的
![alt text](/操作系统/picture/{A5469CA8-102D-4CB1-8D8C-CB4C56C67B56}.png)
![alt text](/操作系统/picture/{B6880107-8E10-4BD7-9E3E-E5C15B5F94C7}.png)
### 3.系统调用的过程
**系统调用的工作原理**
> 系统调用的工作原理涉及用户态和内核态的切换。操作系统中的状态分为管态（核心态）和目态（用户态）。大多数系统交互操>作需要在内核态执行，如设备I/O操作或进程间通信。
> 
> 当用户程序需要访问系统核心功能时，会通过系统调用接口使用系统调用。系统调用的过程如下：
> 
> 用户程序发出系统调用请求。
>
> 根据指令指明系统调用的类型以及参数，存储在寄存器中。
>
> 传递陷入指令
> 
> 操作系统接收到请求后，让处理器进入内核态。
>
> 根据寄存器中的参数判断用户需要哪种系统调用服务
> 
> 内核执行相应的操作，如I/O操作、进程管理等。
> 
> 操作完成后，处理器返回用户态，继续执行用户程序。

![alt text](/操作系统/picture/{FD33652B-7536-474C-808A-D0E4211EBB8B}.png)
### 4.总结
![alt text](/操作系统/picture/{D7B9E0F9-6811-4D7F-8876-4472E71F0F17}.png)

## 七、操作系统体系结构
![alt text](/操作系统/picture/{6C08D4F1-0E57-4424-98F3-04A1C8C61382}.png)
![alt text](/操作系统/picture/{4147FDCA-BF34-4F34-9B66-A63124A018D4}.png)
![alt text](/操作系统/picture/{15B5BBCB-C620-4E2A-B8A8-36CB8C075079}.png)
大内核和微内核会对系统性能有影响。
![alt text](/操作系统/picture/{16E5A37A-23F7-4CCC-AB49-F8083EE40DC0}.png)
### 大内核（又名：宏内核/单内核）
    - 将操作系统的主要功能模块都作为系统内核，运行在核心态
    - 优点：高性能
    - 缺点：内核代码庞大，结构混乱，难以维护
    - 典型的操作系统：linux，UNIX
### 微内核
    - 只把最基本的功能保留在内核
    - 优点：内核功能少，结构清晰，方便维护
    - 缺点：需要频繁的在核心态和用户态之间切换，性能低
    - 典型的操作系统：windows NT
### 分层结构
内核分多层，每层可单向调用更低一层提供的接口。  
> 最底层为硬件，最高层是用户接口。
- 优点：
  1. 便于调试和验证，自底向上逐层调试验证
  2. 易于扩充和维护，各层之间调用接口清晰固定
- 缺点：
  1. 仅可调用相邻底层，难以合理定义各层的边界（例如进程管理需调用内存管理，内存管理也要调用进程管理，对分层结构的设计造成了困难）
  2. 效率低，不可跨层调用，系统调用执行时间长
### 模块化
将内核划为多个模块，各模块之间相互协作。  
内核 = 主模块 + 可加载内核模块  
主模块：只负责核心功能，如进程调度，内存管理  
可加载内核模块：可以动态加载模块到内核，而无需重新编译整个内核。（例如一些驱动程序，外置设备的驱动程序）
![alt text](/操作系统/picture/{BDDFB041-B556-42B4-A7BC-8B2519B1A0F3}.png)
### 外核
内核负责进程调度、进程通信等功能，外核负责为用户进程分配未经抽象的硬件资源，且由外核负责保证资源使用安全。

内核分配的内存空间是经过抽象的连续空间，本质是离散的物理内存，是被连续内存空间映射的，由于本质是离散的内存，所以访问时磁头移动的频繁，移动距离大，不利于频繁的随机访问。而外核直接分配连续物理内存空间，不需要经过抽象化为连续空间，便于频繁的随机访问内存空间。

### 总结
![alt text](/操作系统/picture/{610194E9-F459-4E6D-BEB1-B28099DC81B0}.png)

## 八、操作系统的引导
定义：开机的时候，怎么让操作系统运行起来。  
磁盘按照操作系统后，磁盘开头部分有一个主引导记录（MBR）（包含磁盘引导程序和分区表）。   
分区表是一个数据结构，说明每个磁盘占有多大空间以及每个分区地址范围。
![alt text](/操作系统/picture/{066BDB54-98EF-4C21-93F4-7BE2D087F300}.png)  
c盘安装操作系统，是这个磁盘的活动分区，c盘进一步细分为：引导记录PBR（负责找到启动管理器），根目录，其他。
![alt text](/操作系统/picture/{7D8503BB-9F86-421E-81CB-DDDE91066C9B}.png)
RAM指运行内存，只要关机和断电，数据就被清除。
ROM（BIOS，基本输入\输出系统）包含ROM引导程序，即自举程序。关机与断电不会清除。只要开机通电，CPU就去ROM找ROM引导程序，从而执行指令，将磁盘的主引导记录读入RAM主存中，接着读去磁盘引导程序MBR，接着根据分区表判断c盘位置，进而读取分区引导记录PBR，从根目录找到启动管理器程序，从而完成操作系统初始化。
![alt text](/操作系统/picture/{530F5784-242D-4B47-A72C-96B2D05EF9FD}.png)
windows操作系统完整的初始化程序在 “根目录/windows/Boot”下。

## 九、虚拟机
传统计算机一台物理机器只能运行一个操作系统。但是一个操作系统可以同时运行多个进程，多个进程可能对操作系统的资源有争夺，会有安全隐患，因此发明了虚拟机，将一台物理机器虚拟化为多态虚拟机器，每个虚拟机器都可以独立运行一个操作系统。
![alt text](/操作系统/picture/{24ABDC2E-EA21-465D-94D6-4E3FB2A79749}.png)
### 两类虚拟机管理程序的对比
![alt text](/操作系统/picture/{20EF57F3-4858-4695-B8DC-2727342CA64C}.png)
第一类直接分配在硬件上，是连续的外存，性能更好，而第二类是经过宿主操作系统分配的虚拟内存，是通过多层映射的离散外存，性能差。